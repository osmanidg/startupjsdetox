name: Tests
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  test:
    timeout-minutes: 60
    runs-on: macos-12
#    env:
#      DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    - run: brew tap wix/brew
    - run: brew install applesimutils
#    - run: npm install -g react-native-cli
    - run: npm install -g detox-cli
#    - name: Show simulator info
#      run: applesimutils --byName "iPhone 14" --list | grep 'udid' | sed 's/.*:.*\"\(.*\)\",/\1/'
#    - name: Run iOS simulator
#      run: open -a /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app --args -CurrentDeviceUDID $(applesimutils --byName "iPhone 14" --list | grep 'udid' | sed 's/.*:.*\"\(.*\)\",/\1/')
#    - uses: JarvusInnovations/background-action@v1
#      name: Run iOS simulator
#      with:
#        wait-for: 1m
#        wait-on: xcrun simctl list devices booted | grep "iPhone 14"
#        run: open -a /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app --args -CurrentDeviceUDID $(applesimutils --byName "iPhone 14" --list | grep 'udid' | sed 's/.*:.*\"\(.*\)\",/\1/')
    - name: Install dependencies
      run: yarn
    - name: Start MongoDB
      uses: ankane/setup-mongodb@v1
      with:
        mongodb-version: '5.0'
    - name: Start Redis
      uses: shogo82148/actions-setup-redis@v1
      with:
        redis-version: '6'
    - run: cd ./ios && pod install && cd ..
#    - run: react-native start
    - name: Background App Server
      uses: BerniWittmann/background-server-action@v1
      with:
        start: yarn start
        wait-on: "http://localhost:3000"
    - uses: futureware-tech/simulator-action@v2
      name: Run Simulator
      with:
        model: 'iPhone 13'
    - name: Open iOS simulator
      run: open -a /Applications/Xcode.app/Contents/Developer/Applications/Simulator.app --args -CurrentDeviceUDID $(applesimutils --byName "iPhone 14" --list | grep 'udid' | sed 's/.*:.*\"\(.*\)\",/\1/')
    - name: Build with detox
      run: detox build --configuration ios.sim.release
    - name: Run tests with detox
      run: detox test --configuration ios.sim.release
#      env:
#        CI: true
    - uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
